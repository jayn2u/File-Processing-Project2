name: íŒŒì²˜ ë‘ ë²ˆì§¸ ê³¼ì œ CI

on:
  push:
    branches:
      - feat/*
      - test
      - main

jobs:
  project2-test:
    runs-on: ubuntu-22.04

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: C ì»´íŒŒì¼ëŸ¬ ì„¤ì¹˜
        run: sudo apt update && sudo apt install -y gcc

      - name: flashmemory ìƒì„± í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c
          
          echo "ì»´íŒŒì¼ ì™„ë£Œ"
          file a.out
          
          for BLOCKS in 1 5 10 20; do
            echo "âœ… ë¸”ë¡ ìˆ˜ $BLOCKSë¡œ flashmemory ìƒì„± í…ŒìŠ¤íŠ¸"
            rm -f flashmemory  # ì´ì „ íŒŒì¼ ì‚­ì œ
            ./a.out c flashmemory $BLOCKS
          
            EXPECTED_SIZE=$((BLOCKS * 8 * 528))
            FILESIZE=$(stat --format=%s flashmemory)
          
            echo "flashmemory í¬ê¸°: $FILESIZE ë°”ì´íŠ¸ (ì˜ˆìƒ: $EXPECTED_SIZE ë°”ì´íŠ¸)"
          
            if [ "$FILESIZE" -ne "$EXPECTED_SIZE" ]; then
              echo "âŒ ì‹¤íŒ¨: ì˜ˆìƒ $EXPECTED_SIZE ë°”ì´íŠ¸, ì‹¤ì œ $FILESIZE ë°”ì´íŠ¸"
              exit 1
            else
              echo "âœ… ì„±ê³µ: í¬ê¸° ì¼ì¹˜ ($EXPECTED_SIZE ë°”ì´íŠ¸)"
            fi
          
            echo ""
          done

      - name: write ëª…ë ¹ í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c

          # Step 2: í˜ì´ì§€ 2ë²ˆì— ì“°ê¸°
          ./a.out w flashmemory 2 "helloCI" "123"

          # Step 3: í•´ë‹¹ ìœ„ì¹˜ ì½ì–´ì„œ ë°ì´í„° í™•ì¸
          OFFSET=$((2 * 528))
          hexdump -C -n 16 -s $OFFSET flashmemory > written.txt
          grep -q "68 65 6c 6c 6f 43 49" written.txt && echo "âœ… write ì„±ê³µ" || (echo "âŒ write ì‹¤íŒ¨" && exit 1)

          # Step 4: ê°™ì€ ìœ„ì¹˜ì— ë‹¤ì‹œ ì“°ê¸° ì‹œë„ (ê±°ë¶€ë˜ì–´ì•¼ í•¨)
          ./a.out w flashmemory 2 "overwrite" "456" > try.txt

          # Step 5: ë®ì–´ì“°ê¸° ì•ˆ ëœ ê²ƒ í™•ì¸
          hexdump -C -n 16 -s $OFFSET flashmemory > written2.txt
          grep -q "helloCI" written2.txt && echo "âœ… ë®ì–´ì“°ê¸° ë°©ì§€ í™•ì¸" || (echo "âŒ ë®ì–´ì“°ê¸° ë°©ì§€ ì‹¤íŒ¨" && exit 1)

          # ì •ë¦¬
          rm -f flashmemory written.txt written2.txt try.txt

      - name: read ëª…ë ¹ í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c
          
          # í…ŒìŠ¤íŠ¸ 1: ì •ìƒì ì¸ ì½ê¸°
          ./a.out w flashmemory 2 "abcd12345@%$" "12"
          ./a.out r flashmemory 2 > r1.txt
          grep -q "abcd12345@%$ 12" r1.txt && echo "âœ… read í…ŒìŠ¤íŠ¸ 1 í†µê³¼" || (echo "âŒ read í…ŒìŠ¤íŠ¸ 1 ì‹¤íŒ¨" && cat r1.txt && exit 1)
          rm flashmemory

          # í…ŒìŠ¤íŠ¸ 2: sectorê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì¶œë ¥ ì•ˆ í•¨
          ./a.out w flashmemory 2 "" "12"
          ./a.out r flashmemory 2 > r2.txt
          [ ! -s r2.txt ] && echo "âœ… read í…ŒìŠ¤íŠ¸ 2 í†µê³¼" || (echo "âŒ read í…ŒìŠ¤íŠ¸ 2 ì‹¤íŒ¨ (ì¶œë ¥ ìˆìŒ)" && cat r2.txt && exit 1)
          rm flashmemory

          # í…ŒìŠ¤íŠ¸ 3: ì™„ì „ ë¹ˆ í˜ì´ì§€ (ì•„ë¬´ê²ƒë„ ì•ˆ ì”€)
          ./a.out c flashmemory 4
          ./a.out r flashmemory 4 > r3.txt
          [ ! -s r3.txt ] && echo "âœ… read í…ŒìŠ¤íŠ¸ 3 í†µê³¼" || (echo "âŒ read í…ŒìŠ¤íŠ¸ 3 ì‹¤íŒ¨ (ì¶œë ¥ ìˆìŒ)" && cat r3.txt && exit 1)

          # í…ŒìŠ¤íŠ¸ 4: ë®ì–´ì“°ê¸° ë°©ì§€ëœ í˜ì´ì§€ ì½ê¸°
          ./a.out w flashmemory 5 "firstdata" "55"
          ./a.out w flashmemory 5 "second" "99"  # ë¬´ì‹œë¼ì•¼ í•¨
          ./a.out r flashmemory 5 > r4.txt
          # "firstdata 55"ê°€ ì¶œë ¥ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          grep -q "firstdata 55" r4.txt && echo "âœ… read í…ŒìŠ¤íŠ¸ 4 í†µê³¼" || (echo "âŒ read í…ŒìŠ¤íŠ¸ 4 ì‹¤íŒ¨" && cat r4.txt && exit 1)

          # ì •ë¦¬
          rm -f flashmemory r1.txt r2.txt r3.txt r4.txt

      - name: erase ëª…ë ¹ í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c
          # Step 1: í”Œë˜ì‹œ ìƒì„± (1 ë¸”ë¡ = 8 í˜ì´ì§€)
          ./a.out c flashmemory 1

          # Step 2: í˜ì´ì§€ì— ë°ì´í„° ì‘ì„± (ppn = 4ëŠ” block 0ì— ì†í•¨)
          ./a.out w flashmemory 4 "beforeErase" "999"
          ./a.out r flashmemory 4 > before.txt
          grep -q "beforeErase 999" before.txt && echo "âœ… erase ì „ ì“°ê¸° í™•ì¸" || (echo "âŒ ì“°ê¸° ì‹¤íŒ¨" && cat before.txt && exit 1)

          # Step 3: ë¸”ë¡ 0 ì†Œê±°
          ./a.out e flashmemory 0

          # Step 4: ì†Œê±°ëœ í˜ì´ì§€ëŠ” ì¶œë ¥ ì—†ì–´ì•¼ í•¨ (sector, spare ëª¨ë‘ ì§€ì›Œì¡ŒëŠ”ì§€)
          ./a.out r flashmemory 4 > after.txt
          [ ! -s after.txt ] && echo "âœ… erase í›„ í˜ì´ì§€ ì´ˆê¸°í™” í™•ì¸" || (echo "âŒ erase ì‹¤íŒ¨ (ë°ì´í„° ë‚¨ìŒ)" && cat after.txt && exit 1)

          # ì •ë¦¬
          rm -f flashmemory before.txt after.txt

      - name: update ëª…ë ¹ ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c
          #########################################
          echo "ğŸ§ª T1. ê¸°ë³¸ update ë™ì‘ í…ŒìŠ¤íŠ¸"
          ./a.out c flashmemory 3
          ./a.out w flashmemory 11 "old" "11"
          ./a.out u flashmemory 11 "newData!" "99" > log1.txt
          ./a.out r flashmemory 11 > out1.txt
          grep -q "newData! 99" out1.txt && echo "âœ… T1 í†µê³¼" || (echo "âŒ T1 ì‹¤íŒ¨" && cat out1.txt && exit 1)

          #########################################
          echo "ğŸ§ª T2. ê°™ì€ í˜ì´ì§€ì— ë‘ ë²ˆ ì—°ì† update"
          ./a.out u flashmemory 11 "second" "88" > log2.txt
          ./a.out r flashmemory 11 > out2.txt
          grep -q "second 88" out2.txt && echo "âœ… T2 í†µê³¼" || (echo "âŒ T2 ì‹¤íŒ¨" && cat out2.txt && exit 1)

          #########################################
          echo "ğŸ§ª T3. ë‚˜ë¨¸ì§€ í˜ì´ì§€ ë³´ì¡´ í™•ì¸"
          ./a.out w flashmemory 10 "stay" "22"
          ./a.out u flashmemory 11 "final!" "44"
          ./a.out r flashmemory 10 > out3.txt
          grep -q "stay 22" out3.txt && echo "âœ… T3 í†µê³¼" || (echo "âŒ T3 ì‹¤íŒ¨ - ë‹¤ë¥¸ í˜ì´ì§€ ì†ì‹¤" && cat out3.txt && exit 1)

          #########################################
          echo "ğŸ§ª T5. sectorëŠ” ê·¸ëŒ€ë¡œ, spareë§Œ ë³€ê²½"
          ./a.out c flashmemory 3
          ./a.out w flashmemory 9 "constant" "33"
          ./a.out u flashmemory 9 "constant" "77"
          ./a.out r flashmemory 9 > out5.txt
          grep -q "constant 77" out5.txt && echo "âœ… T5 í†µê³¼" || (echo "âŒ T5 ì‹¤íŒ¨ - spare ë³€ê²½ ì•ˆ ë¨" && cat out5.txt && exit 1)

          #########################################
          echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„ ì •ë¦¬"
          rm -f flashmemory out*.txt log*.txt

      - name: ì¶”ê°€ í…ŒìŠ¤íŠ¸
        run: |
          gcc -o a.out ftlmgr.c fdevicedriver.c

          echo "ğŸ§ª T6. write â†’ read â†’ erase â†’ read: í˜ì´ì§€ ì™„ì „ ì´ˆê¸°í™” í™•ì¸"
          ./a.out c flashmemory 2
          ./a.out w flashmemory 4 "eraseCheck" "55"
          ./a.out r flashmemory 4 > beforeErase.txt
          grep -q "eraseCheck 55" beforeErase.txt || (echo "âŒ T6 ì‹¤íŒ¨ - write ë˜ëŠ” read ì‹¤íŒ¨" && cat beforeErase.txt && exit 1)
          ./a.out e flashmemory 0
          ./a.out r flashmemory 4 > afterErase.txt
          [ ! -s afterErase.txt ] && echo "âœ… T6 í†µê³¼" || (echo "âŒ T6 ì‹¤íŒ¨ - erase í›„ì—ë„ ë°ì´í„° ì¡´ì¬" && cat afterErase.txt && exit 1)

          echo "ğŸ§ª T7. ìµœëŒ€ í˜ì´ì§€ ë²ˆí˜¸(ppn = 8*block - 1)ì— ì“°ê³  ì½ê¸°"
          ./a.out c flashmemory 3
          MAX_PPN=$((8*3 - 1))
          ./a.out w flashmemory $MAX_PPN "maxPage" "77"
          ./a.out r flashmemory $MAX_PPN > out7.txt
          grep -q "maxPage 77" out7.txt && echo "âœ… T7 í†µê³¼" || (echo "âŒ T7 ì‹¤íŒ¨ - ìµœëŒ€ í˜ì´ì§€ ì²˜ë¦¬ ì‹¤íŒ¨" && cat out7.txt && exit 1)

          echo "ğŸ§ª T8. update ì‹œ ë¹ˆ ë¸”ë¡ì„ ì œëŒ€ë¡œ íƒìƒ‰í–ˆëŠ”ì§€ í™•ì¸"
          ./a.out c flashmemory 5
          ./a.out w flashmemory 8 "original" "88"
          ./a.out u flashmemory 8 "updated" "99"
          ./a.out r flashmemory 8 > out8.txt
          grep -q "updated 99" out8.txt && echo "âœ… T8 í†µê³¼" || (echo "âŒ T8 ì‹¤íŒ¨ - update ì‹¤íŒ¨" && cat out8.txt && exit 1)

          echo "ğŸ§ª T9. update ê³¼ì • ì¤‘ ë‹¤ë¥¸ í˜ì´ì§€ê°€ ë³´ì¡´ë˜ëŠ”ì§€ ê²€ì¦"
          ./a.out c flashmemory 4
          ./a.out w flashmemory 15 "preserved" "15"
          ./a.out w flashmemory 16 "toupdate" "16"
          ./a.out u flashmemory 16 "changed" "77"
          ./a.out r flashmemory 15 > out9.txt
          grep -q "preserved 15" out9.txt && echo "âœ… T9 í†µê³¼" || (echo "âŒ T9 ì‹¤íŒ¨ - ë³´ì¡´ë˜ì§€ ì•ŠìŒ" && cat out9.txt && exit 1)

          echo "ğŸ§ª T10. ì™„ì „ ì´ˆê¸°í™”ëœ í˜ì´ì§€ ì½ê¸° â†’ ì¶œë ¥ ì—†ìŒ"
          ./a.out c flashmemory 2
          ./a.out r flashmemory 0 > out10.txt
          [ ! -s out10.txt ] && echo "âœ… T10 í†µê³¼" || (echo "âŒ T10 ì‹¤íŒ¨ - ì´ˆê¸°í™”ëœ í˜ì´ì§€ ì¶œë ¥ë¨" && cat out10.txt && exit 1)

          echo "ğŸ§ª T11. spare ë°ì´í„°ê°€ 0ì¼ ë•Œ ì •ìƒ ì¶œë ¥ë˜ëŠ”ì§€ í™•ì¸"
          ./a.out c flashmemory 2
          ./a.out w flashmemory 1 "dataZero" "0"
          ./a.out r flashmemory 1 > out11.txt
          grep -q "dataZero 0" out11.txt && echo "âœ… T11 í†µê³¼" || (echo "âŒ T11 ì‹¤íŒ¨ - spare=0 ì¶œë ¥ ì•ˆ ë¨" && cat out11.txt && exit 1)

          echo "ğŸ§ª T12. ì—°ì† í˜ì´ì§€ write-read í…ŒìŠ¤íŠ¸"
          ./a.out c flashmemory 2
          for i in {0..7}; do
            ./a.out w flashmemory $i "page$i" "$i"
          done
          for i in {0..7}; do
            ./a.out r flashmemory $i > out12_$i.txt
            grep -q "page$i $i" out12_$i.txt || (echo "âŒ T12 ì‹¤íŒ¨ - ppn $i" && cat out12_$i.txt && exit 1)
          done
          echo "âœ… T12 í†µê³¼"

          echo "ğŸ§¹ ì •ë¦¬"
          rm -f flashmemory beforeErase.txt afterErase.txt out*.txt

      - name: create flash memory
        run: |
          gcc ftlmgr.c fdevicedriver.c -o a.out
          
          for BLOCKS in 5 10 20; do
          FILE="flashmemory_$BLOCKS"
          
          ./a.out c $FILE $BLOCKS
          
          # ì˜ˆìƒ í¬ê¸° ê³„ì‚°: BLOCKS * 8 * (512 + 16)
          EXPECTED_SIZE=$((BLOCKS * 8 * 528))
          FILESIZE=$(stat --format=%s $FILE)
          
          echo "ğŸ“ [$FILE] í¬ê¸°: $FILESIZE ë°”ì´íŠ¸ (ì˜ˆìƒ: $EXPECTED_SIZE ë°”ì´íŠ¸)"
          
          if [ "$FILESIZE" -ne "$EXPECTED_SIZE" ]; then
          echo "âŒ íŒŒì¼ í¬ê¸° ì˜¤ë¥˜: ì˜ˆìƒ $EXPECTED_SIZE ë°”ì´íŠ¸, ì‹¤ì œ $FILESIZE ë°”ì´íŠ¸"
          exit 1
          else
          echo "âœ… íŒŒì¼ í¬ê¸° ì •ìƒ ($EXPECTED_SIZE ë°”ì´íŠ¸)"
          fi
          
          echo ""
          done

      - name: write page
        run: |
          gcc ftlmgr.c fdevicedriver.c -o a.out
          
          #############################
          # TEST 1: ì¼ë°˜ì ì¸ ê²½ìš°
          #############################
          
          ./a.out c flashmemory 10
          ./a.out w flashmemory 5 "abc123!" "42"
          
          dd if=flashmemory bs=528 skip=5 count=1 of=readpage.bin status=none
          
          echo ""
          echo "test 1 ë¶„ì„"
          
          # âœ… ì„¹í„° ë¬¸ìì—´ í™•ì¸ ë° ê²€ì‚¬
          SECTOR_STRING=$(dd if=readpage.bin bs=1 count=512 status=none | strings | head -n 1)
          EXPECTED_SECTOR="abc123!"
          
          if [ "$SECTOR_STRING" != "$EXPECTED_SECTOR" ]; then
          echo "âŒ ì„¹í„° ì˜ì—­ ë¬¸ìì—´ ë¶ˆì¼ì¹˜!"
          echo "   ì…ë ¥í•œ ì„¹í„° ë°ì´í„°: $EXPECTED_SECTOR"
          echo "   ì €ì¥ëœ ì„¹í„° ë°ì´í„°: $SECTOR_STRING"
          echo "ğŸ’¥ write-page-test 1 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ì„¹í„° ì˜ì—­ ë¬¸ìì—´ í™•ì¸ ì™„ë£Œ: \"$SECTOR_STRING\""
          fi
          
          # âœ… ìŠ¤í˜ì–´ ì˜ì—­ ê²€ì‚¬
          SPARE_HEX=$(xxd -s 512 -l 4 -p readpage.bin)
          EXPECTED_SPARE="2a000000"
          
          if [ "$SPARE_HEX" != "$EXPECTED_SPARE" ]; then
          echo "âŒ ìŠ¤í˜ì–´ ì˜ì—­ binary ê°’ì´ ì˜ˆìƒê³¼ ë‹¤ë¦„! (42 â†’ $EXPECTED_SPARE)"
          echo "ğŸ’¥ write-page-test 1 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ìŠ¤í˜ì–´ ì˜ì—­ binary ê°’ í™•ì¸ ì™„ë£Œ (42 â†’ $EXPECTED_SPARE)"
          fi
          
          # âœ… ìµœì¢… í†µê³¼ ë©”ì‹œì§€
          echo "ğŸ‰ write-page-test 1 ì„±ê³µ!"
          
          #############################
          # TEST 2: ë¹ˆ ì„¹í„° ë°ì´í„° í™•ì¸
          #############################
          ./a.out c flashmemory 10
          ./a.out w flashmemory 6 "" "77"
          
          dd if=flashmemory bs=528 skip=6 count=1 of=readpage2.bin status=none
          
          echo ""
          echo "test 2 ë¶„ì„ (ë¹ˆ ì„¹í„°)"
          
          SECTOR_BYTES=$(dd if=readpage2.bin bs=1 count=512 status=none | hexdump -v -e '/1 "%02x"')
          
          # ì „ë¶€ 0xFFì¸ì§€ í™•ì¸
          if [[ "$SECTOR_BYTES" != $(printf 'ff%.0s' {1..512}) ]]; then
          echo "âŒ ì„¹í„° ì˜ì—­ì´ 0xFFë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ!"
          echo "ğŸ’¥ write-page-test 2 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ë¹ˆ ì„¹í„° ë°ì´í„° â†’ ì„¹í„° ì˜ì—­ì´ 0xFFë¡œ ì´ˆê¸°í™”ë¨"
          fi
          
          SPARE_HEX=$(xxd -s 512 -l 4 -p readpage2.bin)
          if [ "$SPARE_HEX" != "4d000000" ]; then  # 77 = 0x4d = 4d000000 (little endian)
          echo "âŒ ìŠ¤í˜ì–´ ê°’ì´ 77(4d000000)ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŒ!"
          echo "ğŸ’¥ write-page-test 2 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ìŠ¤í˜ì–´ ì˜ì—­ binary ê°’ í™•ì¸ ì™„ë£Œ (77 â†’ $SPARE_HEX)"
          echo "ğŸ‰ write-page-test 2 ì„±ê³µ!"
          fi
          
          #############################
          # TEST 3: ë¹ˆ ìŠ¤í˜ì–´ ë°ì´í„° í™•ì¸
          #############################
          ./a.out c flashmemory 10
          ./a.out w flashmemory 7 "xyz!!" ""
          
          dd if=flashmemory bs=528 skip=7 count=1 of=readpage3.bin status=none
          
          echo ""
          echo "test 3 ë¶„ì„ (ë¹ˆ ìŠ¤í˜ì–´)"
          
          SECTOR_STRING=$(dd if=readpage3.bin bs=1 count=512 status=none | strings | head -n 1)
          EXPECTED_SECTOR="xyz!!"
          
          if [ "$SECTOR_STRING" != "$EXPECTED_SECTOR" ]; then
          echo "âŒ ì„¹í„° ë¬¸ìì—´ì´ ì˜ˆìƒê³¼ ë‹¤ë¦„!"
          echo "ğŸ’¥ write-page-test 3 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ì„¹í„° ë¬¸ìì—´ í™•ì¸ ì™„ë£Œ: \"$SECTOR_STRING\""
          fi
          
          SPARE_HEX=$(xxd -s 512 -l 4 -p readpage3.bin)
          if [ "$SPARE_HEX" != "00000000" ]; then
          echo "âŒ ë¹ˆ ìŠ¤í˜ì–´ëŠ” 0ìœ¼ë¡œ ì €ì¥ë˜ì–´ì•¼ í•¨! â†’ í˜„ì¬ ê°’: $SPARE_HEX"
          echo "ğŸ’¥ write-page-test 3 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ë¹ˆ ìŠ¤í˜ì–´ â†’ 0ìœ¼ë¡œ ì •ìƒ ì €ì¥ (00000000)"
          echo "ğŸ‰ write-page-test 3 ì„±ê³µ!"
          fi
          
          #############################
          # TEST 4: ì„¹í„° + ìŠ¤í˜ì–´ ëª¨ë‘ ë¹ˆ ê²½ìš°
          #############################
          ./a.out c flashmemory 10
          ./a.out w flashmemory 8 "" ""
          
          dd if=flashmemory bs=528 skip=8 count=1 of=readpage4.bin status=none
          
          echo ""
          echo "test 4 ë¶„ì„ (ì„¹í„°/ìŠ¤í˜ì–´ ëª¨ë‘ ë¹ˆ ì…ë ¥)"
          
          # ì„¹í„° ì˜ì—­ ê²€ì¦ (ëª¨ë‘ 0xFF)
          SECTOR_BYTES=$(dd if=readpage4.bin bs=1 count=512 status=none | hexdump -v -e '/1 "%02x"')
          
          if [[ "$SECTOR_BYTES" != $(printf 'ff%.0s' {1..512}) ]]; then
          echo "âŒ ì„¹í„° ì˜ì—­ì´ 0xFFë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ!"
          echo "ğŸ’¥ write-page-test 4 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ë¹ˆ ì„¹í„° â†’ ì„¹í„° ì˜ì—­ì´ 0xFFë¡œ ì´ˆê¸°í™”ë¨"
          fi
          
          # ìŠ¤í˜ì–´ ì˜ì—­ ê²€ì¦ (0ìœ¼ë¡œ ì €ì¥)
          SPARE_HEX=$(xxd -s 512 -l 4 -p readpage4.bin)
          if [ "$SPARE_HEX" != "00000000" ]; then
          echo "âŒ ë¹ˆ ìŠ¤í˜ì–´ â†’ 0ì´ ì €ì¥ë˜ì§€ ì•ŠìŒ! í˜„ì¬: $SPARE_HEX"
          echo "ğŸ’¥ write-page-test 4 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ë¹ˆ ìŠ¤í˜ì–´ â†’ 0ìœ¼ë¡œ ì •ìƒ ì €ì¥"
          echo "ğŸ‰ write-page-test 4 ì„±ê³µ!"
          fi
          
          #############################
          # TEST 5: ê¸°ì¡´ í˜ì´ì§€ì— ë®ì–´ì“°ê¸° ë°©ì§€
          #############################
          ./a.out c flashmemory 10
          ./a.out w flashmemory 9 "original" "99"
          
          # ì²« ë²ˆì§¸ ì“°ê¸° í›„ ê°’ ì €ì¥
          dd if=flashmemory bs=528 skip=9 count=1 of=before_overwrite.bin status=none
          
          # ë®ì–´ì“°ê¸° ì‹œë„ (ê°™ì€ ppn = 9)
          ./a.out w flashmemory 9 "newdata" "55"
          
          # ë‹¤ì‹œ ì½ì–´ì„œ ë¹„êµ
          dd if=flashmemory bs=528 skip=9 count=1 of=after_overwrite.bin status=none
          
          echo ""
          echo "test 5 ë¶„ì„ (ë®ì–´ì“°ê¸° ë°©ì§€ í…ŒìŠ¤íŠ¸)"
          
          # ğŸ” before ë‚´ìš© ì¶œë ¥
          echo "ğŸ“‚ BEFORE ë®ì–´ì“°ê¸° í˜ì´ì§€ ë‚´ìš© (ì• 64B)"
          hexdump -C before_overwrite.bin
          
          # ğŸ” after ë‚´ìš© ì¶œë ¥
          echo "ğŸ“‚ AFTER ë®ì–´ì“°ê¸° í˜ì´ì§€ ë‚´ìš© (ì• 64B)"
          hexdump -C after_overwrite.bin
          
          # ë°”ì´íŠ¸ ë‹¨ìœ„ ê°’ ë¹„êµë¥¼ ìœ„í•´ md5 í•´ì‹œë¡œ ë¹„êµ
          HASH1=$(md5sum before_overwrite.bin | cut -d' ' -f1)
          HASH2=$(md5sum after_overwrite.bin | cut -d' ' -f1)
          
          if [ "$HASH1" != "$HASH2" ]; then
          echo "âŒ ê¸°ì¡´ ë°ì´í„°ê°€ ë³€ê²½ë¨! í•´ì‹œ ë¶ˆì¼ì¹˜!"
          echo "ğŸ’¥ write-page-test 5 ì‹¤íŒ¨!"
          exit 1
          else
          echo "âœ… ê¸°ì¡´ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨ (í•´ì‹œ ì¼ì¹˜)"
          echo "ğŸ‰ write-page-test 5 ì„±ê³µ!"
          fi

      - name: read page
        run: |
          gcc ftlmgr.c fdevicedriver.c -o a.out
          
          ./a.out c flashmemory 10
          ./a.out w flashmemory 9 "abcd12345@%$" "99"
          READ_OUTPUT=$(./a.out r flashmemory 9)
          
          echo "ğŸ“¤ [TEST 1] ì¶œë ¥: $READ_OUTPUT"
          
          EXPECTED_OUTPUT="abcd12345@%$ 99"
          if [ "$READ_OUTPUT" != "$EXPECTED_OUTPUT" ]; then
          echo "âŒ ì¶œë ¥ ë¶ˆì¼ì¹˜!"
          echo "   ê¸°ëŒ€ê°’: $EXPECTED_OUTPUT"
          echo "   ì‹¤ì œê°’: $READ_OUTPUT"
          exit 1
          else
          echo "âœ… ì¶œë ¥ ì¼ì¹˜: $EXPECTED_OUTPUT"
          fi
          
          ./a.out c flashmemory 10
          ./a.out w flashmemory 8 "" "42"
          READ_OUTPUT=$(./a.out r flashmemory 8)
          echo "ğŸ“¤ [TEST 2] ì¶œë ¥: $READ_OUTPUT"
          if [ "$READ_OUTPUT" != "" ]; then
          echo "âŒ TEST 2 ì‹¤íŒ¨ - ì¶œë ¥ ë¶ˆì¼ì¹˜ (ì„¹í„° ì—†ìŒ, ìŠ¤í˜ì–´ 42)"
          exit 1
          else
          echo "âœ… TEST 2 í†µê³¼"
          fi
          
          ./a.out c flashmemory 10
          READ_OUTPUT=$(./a.out r flashmemory 7)
          echo "ğŸ“¤ [TEST 3] ì¶œë ¥: $READ_OUTPUT"
          if [ "$READ_OUTPUT" != "" ]; then
          echo "âŒ TEST 3 ì‹¤íŒ¨ - ì¶œë ¥ ë¶ˆì¼ì¹˜ (ë¹ˆ í˜ì´ì§€ëŠ” ì•„ë¬´ê²ƒë„ ì¶œë ¥í•˜ì§€ ì•Šì•„ì•¼ í•¨)"
          exit 1
          else
          echo "âœ… TEST 3 í†µê³¼"
          fi

      - name: erase page
        run: |
          gcc ftlmgr.c fdevicedriver.c -o a.out
          
          ./a.out c flashmemory 10
          ./a.out w flashmemory 24 "erase_test_data" "777"
          ./a.out e flashmemory 3
          
          echo "ë¸”ë¡ 3ì˜ ëª¨ë“  í˜ì´ì§€ê°€ 0xFFë¡œ ì´ˆê¸°í™”ëëŠ”ì§€ í™•ì¸"
          # ë¸”ë¡ 3ì˜ í˜ì´ì§€ ë²”ìœ„: ppn 24 ~ 31
          for i in $(seq 24 31); do
          dd if=flashmemory bs=528 skip=$i count=1 of=check_page.bin status=none
          
          # 528ë°”ì´íŠ¸ê°€ ëª¨ë‘ FFì¸ì§€ ê²€ì‚¬
          NON_FF_COUNT=$(xxd -p check_page.bin | tr -d '\n' | grep -oE '[^fF]' | wc -l)
          if [ "$NON_FF_COUNT" -ne 0 ]; then
          echo "âŒ ppn=$i í˜ì´ì§€ê°€ 0xFFë¡œ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
          hexdump -C check_page.bin | head -n 4
          exit 1
          fi
          done
          echo "âœ… erase-block-test í†µê³¼: ë¸”ë¡ 3 ì „ì²´ê°€ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë¨ (0xFF)"

      - name: In-place update
        run: |
          gcc ftlmgr.c fdevicedriver.c -o a.out
          
          ./a.out c flashmemory 10
          ./a.out w flashmemory 5 "abc123" "42"
          
          ./a.out u flashmemory 5 "abcd6789@%$" "30"
          
          echo "ppn=5ì— sectorì™€ spareê°€ ì •í™•íˆ ê°±ì‹ ëëŠ”ì§€ í™•ì¸"
          dd if=flashmemory bs=528 skip=5 count=1 of=check_page.bin status=none
          
          # sector í™•ì¸ (ASCII â†’ HEX)
          EXPECT_SECTOR_HEX=$(echo -n "abcd6789@%$" | xxd -p | tr -d '\n')
          ACTUAL_SECTOR_HEX=$(xxd -p check_page.bin | tr -d '\n' | cut -c1-${#EXPECT_SECTOR_HEX})
          
          if [ "$EXPECT_SECTOR_HEX" != "$ACTUAL_SECTOR_HEX" ]; then
          echo "âŒ ì„¹í„° ë¶ˆì¼ì¹˜!"
          echo "Expected: $EXPECT_SECTOR_HEX"
          echo "Actual  : $ACTUAL_SECTOR_HEX"
          hexdump -C check_page.bin | head -n 4
          exit 1
          fi
          
          # spare í™•ì¸ (ì •ìˆ˜í˜•ìœ¼ë¡œ ì €ì¥ëë‹¤ê³  ê°€ì • â†’ 4ë°”ì´íŠ¸ ê¸°ì¤€)
          EXPECT_SPARE_HEX=$(printf "%08x" 30 | sed 's/../& /g' | awk '{print $4$3$2$1}')
          SPARE_HEX=$(xxd -p check_page.bin | tr -d '\n' | cut -c1025-1032)
          
          if [ "$SPARE_HEX" != "$EXPECT_SPARE_HEX" ]; then
          echo "âŒ ìŠ¤í˜ì–´ ë¶ˆì¼ì¹˜!"
          echo "Expected: $EXPECT_SPARE_HEX"
          echo "Actual  : $SPARE_HEX"
          hexdump -C check_page.bin | head -n 4
          exit 1
          fi
          
          echo "âœ… In-place update í…ŒìŠ¤íŠ¸ í†µê³¼: ppn=5ì˜ sector/spare ì •ìƒ ì—…ë°ì´íŠ¸ë¨"